<div class="row">
    <app-header></app-header>
</div>
<div class="flex-container">
    <div class="menubar">
      <app-menubar></app-menubar>
    </div>
    <div class="right_sidebar">
        <div *ngIf="!enabletable && !enablereport" class="d-flex flex-column">
            <form [formGroup]="form">
                <div class="row">
                    <div class="col-12">
                        <label class="form-label required">Trainee ID</label>
                        <input type="text" placeholder="Enter trainee id" class="form-control" (input)="onSearchChange()" formControlName="trainee_id">
                        <div class="autocomplete-container">
                            <div class="autocomplete-items" *ngIf="filteredOptions.length">
                              <div class="autocomplete-item" *ngFor="let option of filteredOptions" (click)="selectOption(option.unique_ref_id)">
                                {{ option.unique_ref_id }}
                              </div>
                            </div>
                        </div>
                    </div>
                    <div class="py-3">
                        <button type="submit" class="btn btn-primary" (click)="getreports()">Submit</button>
                    </div>
                </div>
            </form>         
        </div>
        <div *ngIf="enabletable && !enablereport">
            <div>
                <img src="./assets/images/back_button.png" class="back_button" (click)="enabletable=false;">
            </div>
            <div class="row py-3">
                <table class="table table-bordered table-hover">
                    <thead class="table_column">
                          <tr>
                            <th>Report Id</th>
                            <th>Date</th>
                            <th>Trainee Id</th>
                            <th>Name</th>
                            <th>Action</th>
                          </tr>	
                          <tr *ngFor="let item of individual_report | paginate: { itemsPerPage: 10, currentPage: currentPage };let i = index">
                            <td>{{item.id}}</td>
                            <td>{{ item.created_at | date:'mediumDate' }}</td>
                            <td>{{item.trainee.unique_ref_id}}</td>
                            <td>{{item.trainee.name}}</td>
                            <td><button type="button" class="btn btn-primary" (click)="viewReport(item)">View Report</button></td>
                          </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <pagination-controls style="text-align: right;" (pageChange)="pageChanged($event)"></pagination-controls>
        </div>
        <div *ngIf="!enabletable && enablereport">
            <div>
                <img src="./assets/images/back_button.png" class="back_button" (click)="enabletable=true;enablereport=false">
                <label style="text-align: center;">Report ID: {{report_id}}</label>
                <img src="./assets/images/printout.png" class="print_out" (click)="generatePDF()">
            </div>
            <div>
                <div class="label_align">
                    <label style="font-size: 20px;color: red;">Trainee:</label>
                    <label>Army No: {{view_report?.trainee?.unique_ref_id}}</label>
                    <label>Rank: {{view_report?.trainee?.rank}}</label>
                    <label>Name: {{view_report?.trainee?.name}}</label>
                    <label>Unit: {{view_report?.trainee?.unit}}</label>
                    <label>Course ID: {{view_report?.trainee?.course}}</label>
                    <label>Time Taken: {{ getTotalTimeTaken() }}</label>
                </div>  
                <div class="label_align">
                    <label style="font-size: 20px;color: red;">Instructor:</label>
                    <label>Army No: {{view_report?.trainer?.unique_ref_id}}</label>
                    <label>Rank: {{view_report?.trainer?.rank}}</label>
                    <label>Name: {{view_report?.trainer?.name}}</label>
                    <label>Unit: {{view_report?.trainer?.unit}}</label>
                </div>  
                <div class="row py-3">
                    <table class="table table-striped" id="tableDataID">
                        <thead class="table_column1">
                            <tr>
                              <th style="text-align: center">Sl.no</th>
                              <th>Obstacle Name</th>
                              <th>Tasks</th>
                              <th>Result</th>
                              <th style="text-align: center">Time Taken</th>
                              <th style="text-align: center">Marks</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let item of report; let i=index">
                                <td style="text-align: center">{{ i + 1 }}.</td>
                                <td [style.color]="getObsColor(item.result)">{{ item.obstacle.name }}</td>
                                <td>
                                  <ng-container *ngFor="let obj of item.data; let idx = index">
                                    <span [style.color]="getTaskColor(obj.result)">
                                      {{ obj.remark }}
                                    </span>
                                    <span *ngIf="(idx + 1) % 3 !== 0 && idx !== item.data.length - 1"> | </span>
                                    <br *ngIf="(idx + 1) % 3 === 0 && idx !== item.data.length - 1">
                                  </ng-container>
                                </td>
                                <!-- <td>
                                  <ng-container *ngFor="let obj of item.data;">
                                      <div [style.color]="obj.result === 0 ? 'grey' : (obj.result === 1 ? 'green' : (obj.result === 2 ? 'red' : 'green'))">{{obj.remark}}</div>
                                  </ng-container>
                                </td> -->
                                <td [style.color]="item.result === 1 ? 'green' : 'red'">{{item.result == 1 ? 'Pass' : 'Fail'}}</td>
                                <td style="text-align: center">{{item.obstacle_duration == null ? 0 : item.obstacle_duration}}</td>
                                <td style="text-align: center">{{item.obtained_score}} / {{item.total_score}}</td>                                                    
                            </tr>
                          </tbody>
                          <tfoot>
                            <tr>
                              <td></td>
                              <td>Total Time Taken</td>
                              <td></td>
                              <td></td>
                              <td style="text-align: center">{{ getTotalTimeTaken() }}</td>
                              <td></td>
                            </tr>
                            <tr>
                              <td></td>
                              <td>Total Marks</td>
                              <td></td>
                              <td></td>
                              <td></td>
                              <td style="text-align: center">{{ getTotalObtainedMarks() }} / {{getTotalMarks()}}</td>
                            </tr>
                          </tfoot>
                    </table>
                </div>
                <!-- <pagination-controls (pageChange)="pageChanged($event)" [maxSize]="5" [responsive]="true"></pagination-controls> -->
            </div>
        </div>
    </div>
  </div>
  <!--PDF-->
  <div id="reportContent" style="position: absolute; left: -9999px;">
    <div class="row" style="border-bottom: 1px solid rgb(178, 177, 177);">
        <app-header></app-header>
    </div>
    <div class="mt-2" style="margin-left: 20px;">
        <p style="text-align: center;">Report ID: {{report_id}}</p>
    </div>
    <div>
        <div style="margin-left: 20px;">
            <div class="label_align">
                <label style="font-size: 20px;color: red;">Trainee:</label>
                <label>Army No: {{view_report?.trainee?.unique_ref_id}}</label>
                <label>Rank: {{view_report?.trainee?.rank}}</label>
                <label>Name: {{view_report?.trainee?.name}}</label>
                <label>Unit: {{view_report?.trainee?.unit}}</label>
                <label>Course ID: {{view_report?.trainee?.course}}</label>
                <label>Time Taken: {{ getTotalTimeTaken() }}</label>
            </div>  
            <div class="label_align">
                <label style="font-size: 20px;color: red;">Instructor:</label>
                <label>Army No: {{view_report?.trainer?.unique_ref_id}}</label>
                <label>Rank: {{view_report?.trainer?.rank}}</label>
                <label>Name: {{view_report?.trainer?.name}}</label>
                <label>Unit: {{view_report?.trainer?.unit}}</label>
            </div>  
            <div class="row py-3">
              <table class="table table-striped" id="tableDataID">
                  <thead class="table_column1">
                      <tr>
                        <th style="text-align: center">Sl.no</th>
                        <th>Obstacle Name</th>
                        <th>Tasks</th>
                        <th>Result</th>
                        <th style="text-align: center">Time Taken</th>
                        <th style="text-align: center">Marks</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of report; let i=index">
                          <td style="text-align: center">{{ i + 1 }}.</td>
                          <td [style.color]="getObsColor(item.result)">{{ item.obstacle.name }}</td>
                          <td>
                            <ng-container *ngFor="let obj of item.data; let idx = index">
                              <span [style.color]="getTaskColor(obj.result)">
                                {{ obj.remark }}
                              </span>
                              <span *ngIf="(idx + 1) % 3 !== 0 && idx !== item.data.length - 1"> | </span>
                              <br *ngIf="(idx + 1) % 3 === 0 && idx !== item.data.length - 1">
                            </ng-container>
                          </td>
                          <!-- <td>
                            <ng-container *ngFor="let obj of item.data;">
                                <div [style.color]="obj.result === 0 ? 'grey' : (obj.result === 1 ? 'green' : (obj.result === 2 ? 'red' : 'green'))">{{obj.remark}}</div>
                            </ng-container>
                          </td> -->
                          <td [style.color]="item.result === 1 ? 'green' : 'red'">{{item.result == 1 ? 'Pass' : 'Fail'}}</td>
                          <td style="text-align: center">{{item.obstacle_duration == null ? 0 : item.obstacle_duration}}</td>
                          <td style="text-align: center">{{item.obtained_score}} / {{item.total_score}}</td>                                                    
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr>
                        <td></td>
                        <td>Total Time Taken</td>
                        <td></td>
                        <td></td>
                        <td style="text-align: center">{{ getTotalTimeTaken() }}</td>
                        <td></td>
                      </tr>
                      <tr>
                        <td></td>
                        <td>Total Marks</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td style="text-align: center">{{ getTotalObtainedMarks() }} / {{getTotalMarks()}}</td>
                      </tr>
                    </tfoot>
              </table>
          </div>
        </div>
    </div>
  </div>